<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="WWei"><title>Istio 核心配置对象 · 嘟嘟喵喵小白秋裤</title><meta name="description" content="Istio 核心配置对象Istio 中的资源分为三组进行管理，分别是 networking.istio.io、config.istio.io 及 authentication.istio.io，下面将进行分别介绍。
#1-1 networking.istio.io该对象在 Istio 中可能是使用频"><meta name="keywords" content="GO,PHP,K8S,Docker,Kubernetes,Istio,项目管理,创业,生活"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title><a href="/">嘟嘟喵喵小白秋裤</a></h3><div class="description"><p>没有困难创造困难~</p></div></div></div><ul class="social-links"><li><a href="http://github.com/lyzhang1999"><i class="fa fa-github"></i></a></li></ul><div class="footer"><a target="_blank" href="/"><span>Theme by </span></a><a href="https://www.caicai.me"> CaiCai </a><span>&</span><a href="https://github.com/Ben02/hexo-theme-Anatole"> Ben</a><div class="by_farbox"><a href="https://hexo.io/zh-cn/" target="_blank">Proudly published with Hexo&#65281;</a></div></div><script async src="https://www.googletagmanager.com/gtag/js?id=UA-35043271-2"></script><script type="text/javascript">window.dataLayer = window.dataLayer || [];
function gtag(){dataLayer.push(arguments);}
gtag('js', new Date());
gtag('config', 'UA-35043271-2');</script></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="/about">关于</a></li><li><a href="/archives">归档</a></li><li><a href="/links">友链</a></li></div><div class="information"><div class="back_btn"><li><a class="fa fa-chevron-left" onclick="window.history.go(-1)"> </a></li></div><div class="avatar"><img src="/images/logo.png"></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>Istio 核心配置对象</a></h3></div><div class="post-content"><h1 id="Istio-核心配置对象"><a href="#Istio-核心配置对象" class="headerlink" title="Istio 核心配置对象"></a>Istio 核心配置对象</h1><p>Istio 中的资源分为三组进行管理，分别是 networking.istio.io、config.istio.io 及 authentication.istio.io，下面将进行分别介绍。</p>
<h2 id="1-1-networking-istio-io"><a href="#1-1-networking-istio-io" class="headerlink" title="#1-1 networking.istio.io"></a>#1-1 networking.istio.io</h2><p>该对象在 Istio 中可能是使用频率最高的，Istio 的流量管理就是通过这一组对象完成的，在这里选择其中最常用的对象进行介绍。</p>
<h3 id="1-1-1-概述"><a href="#1-1-1-概述" class="headerlink" title="#1-1-1 概述"></a>#1-1-1 概述</h3><p>通过 VirtualService 定义一组条件，将符合该条件的流量在对象中配置对应的策略进行处理，最后匹配。以下是几种应用场景。</p>
<ul>
<li>来自服务 A 版本的1服务，如果访问了服务 B ,则把流量转发到 B 的 V2 版本</li>
<li>如果 Header 中包含 “canary=true”，则把服务目标指向服务 Y 的版本 3，否则发给服务 Y 的版本2。</li>
<li>为从服务 M 到服务 N 的所有访问都加入延迟，以测试在网络状况不佳时的表现。</li>
</ul>
<p>流量控制的几个关键对象：</p>
<pre><code>Gateway-&gt;VirtaulService-&gt;TCP/HTTP Router-&gt;DestinationWeight-&gt;Subset:Port</code></pre><h3 id="1-1-2-GateWay"><a href="#1-1-2-GateWay" class="headerlink" title="#1-1-2 GateWay"></a>#1-1-2 GateWay</h3><p>在访问服务时，不论是网格内部访问，还是通过 Ingress 进入网格外部的流量，首先要经过的设施都是 Gateway（网关）。</p>
<p>网格边缘的 Ingress 流量，会通过对应的 Istio Ingress Gateway Controller 进入，网格内部的服务互访，则通过 Mesh 网关进行（Mesh 网关代表网格内部所有的 Sidecar）。</p>
<p>Pilot 会根据 Gateway 和主机名进行检索，如果存在对应的 VirtualService ，则交由 VirtualService 处理，如果是 Mesh Gateway 不存在这一主机名的 VirtualService，则尝试调用 Kubernetes Service；如果都不存在，则发生404错误。<br>这就是为什么在注入了 Istio 的 Pod 在没有建立 VirtualService 之前，无法访问一切外网的原因。如一些 CloudApi 接口，包括支付宝、微信支付等。</p>
<h3 id="1-1-3-VirtualService"><a href="#1-1-3-VirtualService" class="headerlink" title="#1-1-3 VirtualService"></a>#1-1-3 VirtualService</h3><p>VirtualService 主要由以下部分组成</p>
<ul>
<li>Host：主机名称，如果在 Kubernetes 集群中，则这个主机名可以是<code>服务名</code></li>
<li>Gateway：流量来源网关，如果这一字段被省略，则代表使用的网关名为 Mesh，也就是网格内部服务互通的网关。</li>
<li>路由对象：网格中的流量，如果符合前面的 Host 和 Gateway 的条件，就需要根据实际的协议对流量处理方式进行郑甄别。原因是：HTTP 是一种透明协议，可以经过对报文的解析，完成更细致的控制；而对于原始的TCP流量来说，就无法完成过于复杂的任务。</li>
</ul>
<h3 id="1-1-4-TCP-TLS-HTTP-Router"><a href="#1-1-4-TCP-TLS-HTTP-Router" class="headerlink" title="#1-1-4 TCP/TLS/HTTP Router"></a>#1-1-4 TCP/TLS/HTTP Router</h3><p>路由对象可以是 HTTP 、TCP 、TLS，分别针对不同的协议进行工作，每种路由对象至少包含两个部分：匹配条件和目的路由。例如在 HTTPRouter 对象中就包含用于匹配的 HTTPMatchRequest 对象数组，以及用于描述目标服务的 Destination Weight 对象，并且 HTTPMatchRequest 匹配的条件较为丰富，例如 Header 或者 URI 等。除此之外，对于 HTTP 独有的专属属性，例如超时控制、重试、错误注入等。相对来说，TCPRoute 简单很多，它匹配的资源借助 L4MatchRequest 对象完成，其中除 Istio 固有的源标签和 Gateway 以外，仅包含地址和端口。</p>
<p>完成匹配后，就是找到适合的目标了。</p>
<h3 id="1-1-5-DestinationWeight"><a href="#1-1-5-DestinationWeight" class="headerlink" title="#1-1-5 DestinationWeight"></a>#1-1-5 DestinationWeight</h3><p>各协议路由的目标定义是一致的，都由 DestinationWeight 对象数组来完成。DestinationWeight 指的是到某个目标（Destination）的流量权重，类似 L7 负载均衡的权重。所以意味着多个目标可以同时为该 VirtualService 提供服务，并按权重进行流量分配。</p>
<h3 id="1-1-6-Destination"><a href="#1-1-6-Destination" class="headerlink" title="#1-1-6 Destination"></a>#1-1-6 Destination</h3><p>目标对象（Destination）由 Subset 和 Port 两个元素组成，Subset 顾名思义，就是指服务的一个子集，他再 Kubernetes 中代表使用<code>标签选择器</code>区分不同的 Pod （如两个 Deployment），Port 代表的是服务端口。</p>
<h2 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h2><p>至此，流量经过多个对象的逐级处理，成功到达 Pod。</p>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2019-08-09</span><i class="fa fa-tag"></i><a class="tag" href="/tags/Istio/" title="Istio">Istio </a></div></div></div></div><div class="share"><div class="evernote"><a class="fa fa-bookmark" href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank"></a></div><div class="weibo"><a class="fa fa-weibo" href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));"></a></div><div class="twitter"><a class="fa fa-twitter" href="http://twitter.com/home?status=,http://yoursite.com/2019/08/09/Istio 核心配置对象/,嘟嘟喵喵小白秋裤,Istio 核心配置对象,;"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a class="btn" role="navigation" href="/2019/08/09/Istio基本概念/" title="Istio 基本概念">上一篇</a></li><li class="next pagbuttons"><a class="btn" role="navigation" href="/2019/08/06/MYSQL EXPLAIN/" title="Mysql Explain 说明">下一篇</a></li></ul></div></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>